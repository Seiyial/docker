options:
  namespace:
    type: string
    usage: The images namespace user/org (defaults to directus).
    environment: DIRECTUS_IMAGE_NAMESPACE
    default: directus
  prefix:
    type: string
    usage: The image prefix to use
    environment: DIRECTUS_IMAGE_PREFIX
    default: ""
  push:
    type: bool
    usage: Pushes the containers to the registry if specified.
    default: false

tasks:
  #
  # Building
  #
  core:
    usage: Builds a core image
    description: |
      Builds a core image and pushes it to the registry if specified
    options:
      kind:
        type: string
        required: true
        usage: The core image kind (apache, nginx, ...)
      version:
        type: string
        required: true
        usage: The tag/version of the core image
    run:
      - when:
          - not-exists: ./images/core/${kind}/
        command: "echo \"Unknown core kind: ${kind}\" && false"
      - command: docker build -t ${namespace}/${prefix}core:${kind}-${version} -f ./images/core/${kind}/Dockerfile ./images/core/${kind}/

  #
  # Builds a directus suite image
  #
  base:
    usage: Builds a project base image
    description: |
      Builds a project base image and pushes it to the registry
    options:
      project:
        type: string
        required: true
        usage: Directus project name
      version:
        type: string
        required: true
        usage: Directus core image version
      kind:
        type: string
        required: true
        usage: The base image kind (apache, nginx, ...)
        values:
          - apache
    run:
      - when:
          - not-exists: ./images/base/${project}/
        command: "echo \"Unknown project: ${project}\" && false"
      - command: docker build --build-arg CORE_IMAGE=${namespace}/${prefix}core:${kind}-${version} -t ${namespace}/${prefix}${project}:base-${kind}-${version} ./images/base/${project}/${kind}/

  #
  # Manual
  #
  build:
    usage: Manual build
    description: |
      Performs a manual build
    options:
      release:
        type: string
        default: ""
        usage: Directus docker release
    run:
      - set-environment:
          SANDBOX: "true"
          TRAVIS_BRANCH: "master"
          TRAVIS_TAG: "${release}"
      - command: ./bin/build

  #
  # Development environment
  #
  dev:
    usage: Development environment
    description: |
      Starts a development environment
    run:
      - when:
          - not-exists: .env
        command: "echo \"DOCKER_USERNAME=fill_me\" >> .env && echo \"DOCKER_PASSWORD=fill_me\" >> .env"
      - command: docker-compose -f ./sandbox.yml run --rm sandbox
