options:
  base:
    type: string
    usage: The base user/org in which container images will live.
    environment: IMAGE_BASE
    default: directus
  push:
    type: bool
    usage: Should push the image to container registry.

tasks:
  #
  # Building
  #
  build:
    usage: Build a project
    description: |
      Fetches a project from GitHub then builds and [pushes] the container.
    args:
      project:
        type: string
        usage: The project name
        required: true
        values:
          #- api
          #- app
          - directus
      variant:
        type: string
        usage: The variant base image (apache, nginx, ...)
        default: apache
        values:
          - apache
    run:
      - when:
          - not-exists: ./docker/${project}/
        command: "echo \"Unknown project: ${project}\""
      - when:
          - not-exists: ./docker/${project}/
        command: "echo \"Unknown project: ${project}\""
      - command: docker build -t ${base}/${project}:${variant}-base -f ./docker/${project}/${variant}/Dockerfile ./docker/${project}/${variant}
      - when:
          - equal: { push: true }
        task:
          name: push
          args:
            - ${base}/${project}:${variant}-base

  #
  # Publish a container
  #
  push:
    usage: Push registry image
    description: |
      Pushes an image to the container registry
    args:
      fqin:
        type: string
        usage: The FQIN image value
    run:
      - when:
          equal: { push: true }
        command: docker push ${fqin}
      - when:
          equal: { push: false }
        command: echo "Skipping image push because there's no --push flag"
