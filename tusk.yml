options:
  base:
    type: string
    usage: The base user/org in which container images will live.
    environment: IMAGE_BASE
    default: directus
  push:
    type: bool
    usage: Should push the image to container registry.

tasks:
  #
  # Building
  #
  base:
    usage: Builds a base image
    description: |
      Builds a base image and pushes it to the registry if specified
    args:
      project:
        type: string
        usage: The project name
        required: true
        values:
          - directus
      variant:
        type: string
        usage: The variant base image (apache, nginx, ...)
        default: apache
        values:
          - apache
    run:
      - when:
          - not-exists: ./docker/${project}/
        command: "echo \"Unknown project: ${project}\""
      - when:
          - not-exists: ./docker/${project}/base/${variant}/
        command: "echo \"Unknown variant: ${project}/${variant}\""
      - command: docker build -t ${base}/${project}:${variant}-base -f ./docker/${project}/base/${variant}/Dockerfile ./docker/${project}/base/${variant}
      - when:
          - equal: { push: true }
        task:
          name: push
          args:
            - ${base}/${project}:${variant}-base

  #
  # Builds a directus suite image
  #
  directus:
    usage: Builds a directus suite image
    description: |
      Builds a directus suite image and pushes it to the registry
    args:
      release:
        type: string
        usage: The suite version
        required: true
      variant:
        type: string
        usage: The variant base image (apache, nginx, ...)
        default: apache
    run:
      - task:
          name: base
          args:
            - directus
            - ${variant}
      - command: curl -L https://github.com/directus/directus/archive/${release}.zip -o release.zip --ssl-no-revoke
      - command: unzip -q -u -d directus release.zip
      - command: rm -f release.zip
      - command: docker build --build-arg BASE_IMAGE=${base}/directus:${variant}-base -t ${base}/directus:${release}-${variant} -f ./docker/directus/main/Dockerfile ./directus/directus-${release}/
      - command: rm -rf ./directus

  #
  # Publish a container
  #
  push:
    usage: Push registry image
    description: |
      Pushes an image to the container registry
    args:
      fqin:
        type: string
        usage: The FQIN image value
    run:
      - when:
          equal: { push: true }
        command: docker push ${fqin}
      - when:
          equal: { push: false }
        command: echo "Skipping image push because there's no --push flag"
