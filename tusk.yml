options:
  namespace:
    type: string
    usage: The images namespace user/org (defaults to directus).
    environment: DIRECTUS_IMAGE_NAMESPACE
    default: directus
  prefix:
    type: string
    usage: The image prefix to use
    environment: DIRECTUS_IMAGE_PREFIX
    default: ""
  push:
    type: bool
    usage: Pushes the containers to the registry if specified.
    default: false

tasks:
  #
  # Building
  #
  base:
    usage: Builds a base image
    description: |
      Builds a base image and pushes it to the registry if specified
    options:
      kind:
        type: string
        usage: The base image kind (apache, nginx, ...)
        default: apache
        values:
          - apache
      version:
        type: string
        usage: The tag name of the image
        default: latest
    run:
      - when:
          - not-exists: ./docker/base/${kind}/
        command: "echo \"Unknown base kind: base/${kind}\" && false"
      - command: docker build -t ${namespace}/${prefix}base:${kind}-${version} -f ./docker/base/${kind}/Dockerfile ./docker/base/${kind}/
      - when:
          - equal: { push: true }
        task:
          name: push
          args:
            - ${namespace}/${prefix}base:${kind}-${version}

  #
  # Builds a directus suite image
  #
  project:
    usage: Builds a project base image
    description: |
      Builds a project base image and pushes it to the registry
    options:
      name:
        type: string
        required: true
        usage: Directus project name
        values:
          - directus
      base:
        type: string
        usage: Directus base version
        default: latest
      kind:
        type: string
        usage: The base image kind (apache, nginx, ...)
        default: apache
        values:
          - apache
    run:
      - when:
          - not-exists: ./docker/projects/${name}/
        command: "echo \"Unknown project: ${name}\" && false"
      - command: docker build --build-arg BASE_IMAGE=${namespace}/${prefix}base:${kind}-${base} -t ${namespace}/${prefix}${name}:apache-base-${base} ./docker/projects/${name}/base/apache/

      #- when:
      #    - exists: tmp
      #  command: rm -rf ./tmp
      #- command: docker build --build-arg BASE_IMAGE=${namespace}/${prefix}directus:${variant}-base -t ${namespace}/${prefix}directus:${release}-${variant} -f ./docker/directus/main/Dockerfile ./directus/directus-${release}/
      #- command: curl -L https://github.com/directus/directus/archive/${release}.zip -o release.zip --ssl-no-revoke
      #- command: unzip -q -u -d tmp release.zip
      #- command: rm -f release.zip
      #- command: docker build --build-arg BASE_IMAGE=${namespace}/${prefix}directus:${variant}-base -t ${namespace}/${prefix}directus:${release}-${variant} -f ./docker/directus/main/Dockerfile ./directus/directus-${release}/
      #- command: rm -rf ./tmp

  #
  # Publish a container
  #
  push:
    usage: Push registry image
    description: |
      Pushes an image to the container registry
    args:
      fqin:
        type: string
        usage: The FQIN image value
    run:
      - when:
          equal: { push: true }
        command: docker push ${fqin}
      - when:
          equal: { push: false }
        command: echo "Skipping image push because there's no --push flag"
