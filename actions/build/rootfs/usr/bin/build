
#!/usr/bin/env bash

set -e
set -v
set -x

#
# Common
#

source $(dirname $0)/common

#
# Builds an image
#

export DOCKER_IMAGE_KIND="${1}"
export DOCKER_IMAGE_BASE="${REPOSITORY_FULLNAME}:base-${DOCKER_IMAGE_KIND}-${BASE_IMAGE_VERSION}"
export DOCKER_IMAGE_NAME="${REPOSITORY_FULLNAME}:${RELEASE_VERSION}-${DOCKER_IMAGE_KIND}"
export DOCKER_IMAGE_CONTEXT="./releases/${REPOSITORY_NAME}-${RELEASE_VERSION}/"
export DOCKER_IMAGE_PATH="${DOCKER_IMAGE_CONTEXT}/docker/${DOCKER_IMAGE_KIND}/Dockerfile"

#
# Build gives priority to "/docker/<kind>/Dockerfile" if it exists, otherwise uses default image
#

echo "Building '${REPOSITORY_FULLNAME}' using base '${DOCKER_IMAGE_KIND}-${BASE_IMAGE_VERSION}'"

if [ -f "${DOCKER_IMAGE_PATH}" ]; then
  docker build --build-arg BASE_IMAGE=${DOCKER_IMAGE_BASE} -t ${DOCKER_IMAGE_NAME} -f ${DOCKER_IMAGE_PATH} ${DOCKER_IMAGE_CONTEXT}
else
  echo "FROM ${DOCKER_IMAGE_BASE}" | docker build -t ${DOCKER_IMAGE_NAME} -f - ${DOCKER_IMAGE_CONTEXT}
fi
