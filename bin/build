#!/usr/bin/env bash
set -e

function invoke() {
  $(dirname $0)/$1 ${@:2}
}

echo ""
echo "Building images..."
echo "> TRAVIS_TAG = \"${TRAVIS_TAG}\""
echo "> TRAVIS_BRANCH = \"${TRAVIS_BRANCH}\""

export VERSION_PUSH="false"
export VERSION_MAJOR="${TRAVIS_BRANCH}"
export VERSION_MINOR="${TRAVIS_BRANCH}"
export VERSION_PATCH="${TRAVIS_BRANCH}"
export VERSION_PRE="${TRAVIS_BRANCH}"
export VERSION="${TRAVIS_BRANCH}"

if [ "${TRAVIS_TAG}" != "" ]; then
  export VERSION_PUSH="true"
  export VERSION_MAJOR="$(invoke semver get major ${TRAVIS_TAG})"
  export VERSION_MINOR="${VERSION_MAJOR}.$(invoke semver get minor ${TRAVIS_TAG})"
  export VERSION_PATCH="${VERSION_MINOR}.$(invoke semver get patch ${TRAVIS_TAG})"
  export VERSION_PRE="${VERSION_PATCH}-$(invoke semver get prerel ${TRAVIS_TAG})"
  if [ "${VERSION_PRE}" == "${VERSION_PATCH}-" ]; then
    echo "> Pushing version ${VERSION_MAJOR}, ${VERSION_MINOR} and ${VERSION_PATCH} (release)"
  else
    echo "> Pushing version ${VERSION_PRE} (prerelease)"
  fi
else
  echo "> Not a release. Pushes are going to be skipped."
fi

for KIND in ./images/core/*
do
  KIND=$(basename ${KIND})
  echo ""
  echo "> Building [${KIND}] core image..."
  if [ "${VERSION_PRE}" == "${VERSION_PATCH}-" ]; then
    invoke tusk core --kind ${KIND} --version ${VERSION_PATCH}
    docker tag directus/core:${KIND}-${VERSION_PATCH} directus/core:${KIND}-${VERSION_MINOR}
    docker tag directus/core:${KIND}-${VERSION_PATCH} directus/core:${KIND}-${VERSION_MAJOR}
    #docker tag directus/core:${KIND}-${VERSION_PATCH} directus/core:${KIND}-latest
    if [ "${VERSION_PUSH}" == "true" ]; then
      docker push directus/core:${KIND}-${VERSION_PATCH}
      docker push directus/core:${KIND}-${VERSION_MINOR}
      docker push directus/core:${KIND}-${VERSION_MAJOR}
      #docker push directus/core:${KIND}-latest
    fi
  else
    invoke tusk core --kind ${KIND} --version ${VERSION_PRE}
    if [ "${VERSION_PUSH}" == "true" ]; then
      docker push directus/core:${KIND}-${VERSION_PRE}
    fi
  fi
done

for PROJECT in ./images/base/*
do
  for KIND in "${PROJECT}/*"
  do
    KIND=$(basename ${KIND})
    PROJECT=$(basename ${PROJECT})
    echo ""
    echo "> Building [${KIND}] base image for project [${PROJECT}]..."

    if [ "${VERSION_PRE}" == "${VERSION_PATCH}-" ]; then
      invoke tusk base --kind ${KIND} --version ${VERSION_PATCH} --project ${PROJECT}
      docker tag directus/${PROJECT}:base-${KIND}-${VERSION_PATCH} directus/${PROJECT}:base-${KIND}-${VERSION_MINOR}
      docker tag directus/${PROJECT}:base-${KIND}-${VERSION_PATCH} directus/${PROJECT}:base-${KIND}-${VERSION_MAJOR}
      #docker tag directus/${PROJECT}:base-${KIND}-${VERSION_PATCH} directus/${PROJECT}:base-${KIND}-latest
      if [ "${VERSION_PUSH}" == "true" ]; then
        docker push directus/${PROJECT}:base-${KIND}-${VERSION_PATCH}
        docker push directus/${PROJECT}:base-${KIND}-${VERSION_MINOR}
        docker push directus/${PROJECT}:base-${KIND}-${VERSION_MAJOR}
        #docker push directus/${PROJECT}:base-${KIND}-latest
      fi
    else
      invoke tusk base --kind ${KIND} --version ${VERSION_PRE} --project ${PROJECT}
      if [ "${VERSION_PUSH}" == "true" ]; then
        docker push directus/${PROJECT}:base-${KIND}-${VERSION_PRE}
      fi
    fi
  done
done

echo ""
echo "Output images"
echo ""
docker images --format "{{.Repository}}:{{.Tag}}" | grep directus | sort
echo ""
